<html>
  <head>
    <script src="https://apis.google.com/js/client.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <style>
      body {
        margin: 0;
      }
      body,textarea,input {
        font-family: monospace;
        font-size: 12pt;
      }
      .cons {
        height: 100%;
        width: 100%;
        background: black;
        color: #ccc;
        overflow: auto;
      }
      .input-cursor {
        white-space: pre;
      }
      .input-container {
        display: flex;
        width: 100%; 
      }
      .input-container,.output-block {
        padding: 5px;
        margin: 0;
      }
      .input {
        padding: 0;
        margin: 0;
        flex: 1; 
        resize: none;
        width: 100%;
        background: transparent;
        border: none;
        color: white;
        outline: none;
        word-break: break-all;
      }
      .output-block {
        max-width: 100%;
      }
      .output-block-image {
        max-height: 100%;
      }
      .output-block-text {
        word-break: break-all;
        white-space: pre-wrap;
      }
      .ls-item-folder {
        color: #88F;
      }
      .ls-item {
        display: inline-block;
        padding: 5px;
      }
      .full-page-control {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
      .editor-text-area {
        background: black;
        border: none;
        bottom: 20px;
        color: white;
        margin: 0;
        outline: none;
        padding: 5px 10px;
        position: absolute;
        resize: none;
        top: 0;
        width: 100%;
        word-break: break-all;
      }
      .editor-input {
        bottom: 0;
        border: none;
        color: white;
        background: black;
        height: 30px;
        outline: none;
        padding: 5px 10px;
        position: absolute;
        width: 100%;
      }
    </style>
  </head>

  <body>
    <div id="cons" class="cons">
      <div id="output"></div>
      <div id="input-container" class="input-container" style="display:none">
        <div id="input-cursor" class="input-cursor"></div>
        <textarea id="input" class="input"></textarea>
      </div>
    </div>
  </body>

  <script>
    var FOLDER_MIMETYPE = 'application/vnd.google-apps.folder';
    var QUAL_URL = 'https://content-googleapis-test.sandbox.google.com';
    var FIELDS = 'id,title,mimeType,parents(id),fileExtension,downloadUrl,owners(isAuthenticatedUser)';
    var APP_FIELDS = 'id,createUrl,installed,name,openUrlTemplate,primaryFileExtensions,' +
        'primaryMimeTypes,secondaryFileExtensions,secondaryMimeTypes,supportsCreate,useByDefault';
    var $1 = {};
   
    var goog = {};
    goog.inherits = function(childCtor, parentCtor) {
      /** @constructor */
      function tempCtor() {};
      tempCtor.prototype = parentCtor.prototype;
      childCtor.superClass_ = parentCtor.prototype;
      childCtor.prototype = new tempCtor();
      childCtor.prototype.constructor = childCtor;
    };
    goog.base = function(me, opt_methodName, var_args) {
      var caller = arguments.callee.caller;
      if (caller.superClass_) {
        return caller.superClass_.constructor.apply(
            me, Array.prototype.slice.call(arguments, 1));
      }
      var args = Array.prototype.slice.call(arguments, 2);
      var foundCaller = false;
      for (var ctor = me.constructor;
           ctor; ctor = ctor.superClass_ && ctor.superClass_.constructor) {
        if (ctor.prototype[opt_methodName] === caller) {
          foundCaller = true;
        } else if (foundCaller) {
          return ctor.prototype[opt_methodName].apply(me, args);
        }
      }
      if (me[opt_methodName] === caller) {
        return me.constructor.prototype[opt_methodName].apply(me, args);
      } else {
        throw Error(
            'goog.base called from a method of one name ' +
            'to a method of a different name');
      }
    };

    // Utilities
    String.prototype.startsWith = function (value){
      return this.slice(0, value.length) == value;
    };
    String.prototype.endsWith = function (value){
      return this.slice(this.length - value.length) == value;
    };
    var util = {};
    util.array = {};
    util.array.first = function(arr, fn) {
      for (var i = 0; i < arr.length; i++) {
        if (fn(arr[i])) {
          return arr[i];
        }
        return null;
      }
    };
    util.array.each = function(arr, fn) {
      for (var i = 0; i < arr.length; i++) {
        fn(arr[i]);
      }
    };
    util.array.some = function(arr, fn) {
      for (var i = 0; i < arr.length; i++) {
        if (fn(arr[i])) {
          return true;
        }
      }
      return false;
    };
    util.array.all = function(arr, fn) {
      for (var i = 0; i < arr.length; i++) {
        if (!fn(arr[i])) {
          return false;
        }
      }
      return true;
    };
    util.array.none = function(arr, fn) {
      for (var i = 0; i < arr.length; i++) {
        if (fn(arr[i])) {
          return false;
        }
      }
      return true;
    }
    util.array.map = function(arr, fn, opt_noNulls) {
      var newArr = [];
      util.array.each(arr, function(item) {
        var val = fn(item);
        if (!!val || !opt_noNulls) {
          newArr.push(fn(item));
        }
      });
      return newArr;
    };
    util.array.noDups = function(arr, opt_strIdFn) {
      var strIdFn = opt_strIdFn || function(item) { return item; };
      var obj = {};
      var newArray = [];
      for (var i = 0; i < arr.length; i++) {
        var item = arr[i];
        if (!obj[strIdFn(item)]) {
          obj[strIdFn(item)] = true;
          newArray.push(item);
        }
      }
      return newArray;
    };
    util.object = {};
    util.object.each = function(obj, fn) {
      for (var key in obj) {
        fn(obj[key]);
      }
    };
    util.doLater = function(fn) {
      window.setTimeout(fn, 0);
    };
    var Predicates = {};
    Predicates.ALL = function(obj) { return true; };
    var Deferred = function() {
      this.callbacks_ = [];
      this.errbacks_ = [];
      this.val_ = null;
      this.isError_ = false;
      this.hasFired_ = false;
    };
    Deferred.prototype.addCallback = function(cb) {
      this.addCallbacks(cb, null);
    };
    Deferred.prototype.addErrback = function(eb) {
      this.addCallbacks(null, eb);
    };
    Deferred.prototype.addCallbacks = function(cb, eb) {
      if (cb) {
        this.callbacks_.push(cb);
      }
      if (eb) {
        this.errbacks_.push(eb);
      }
      if (this.hasFired_) {
        if (this.isError_ && eb) {
          eb(this.val_);
        } else if (cb) {
          cb(this.val_);
        }
      }
    };
    Deferred.prototype.addBoth = function(fn) {
      this.addCallbacks(fn, fn);
    };
    Deferred.prototype.callback = function(val) {
      this.val_ = val;
      this.hasFired_ = true;
      util.array.each(this.callbacks_, function(callback) {
        callback(this.val_);
      }.bind(this));
    };
    Deferred.prototype.errback = function(val) {
      this.val_ = val;
      this.hasFired_ = true;
      this.isError_ = true;
      util.array.each(this.errbacks_, function(errback) {
        errback(this.val_);
      }.bind(this));
    };
    Deferred.prototype.follow = function(other) {
      other.addCallbacks(this.callback.bind(this), this.errback.bind(this));
    };
    Deferred.succeed = function(val) {
      var deferred = new Deferred();
      deferred.callback(val);
      return deferred;
    };
    Deferred.fail = function(val) {
      var deferred = new Deferred();
      deferred.errback(val);
      return deferred;
    };
    var queryParam = function(name) {
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
          results = regex.exec(location.search);
      return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    };
    var TrieNode = function(prefix, value) {
      this.children = {};
      this.prefix = prefix;
      this.value = value;
    };
    TrieNode.prototype.find = function(prefix) {
      var trieNode = this;
      for (var i = 0; i < prefix.length; i++) {
        var ch = prefix.charAt(i);
        if (!(trieNode = trieNode.children[ch])) {
          return null;
        }
      }
      return trieNode;
    };
    var WordTabCompleter = function(words) {
      this.trieRoot_ = new TrieNode('', []);
      if (words) { this.addAll(words); }
    };
    WordTabCompleter.prototype.complete = function(prefix) {
      var trieNode = this.trieRoot_.find(prefix);
      while (trieNode && Object.keys(trieNode.children).length == 1) {
        trieNode = trieNode.children[Object.keys(trieNode.children)[0]];
      }
      return trieNode ? trieNode.prefix : null;
    };
    WordTabCompleter.prototype.list = function(prefix) {
      var match = this.trieRoot_.find(prefix);
      return match ? match.value : []; 
    };
    WordTabCompleter.prototype.clear = function() {
      this.trieRoot_ = new TrieNode('', []);
    };
    WordTabCompleter.prototype.add = function(word) {
      this.trieRoot_.value.push(word);
      var trieNode = this.trieRoot_;
      for (var i = 0; i < word.length; i++) {
        var ch = word.charAt(i);
        if (!trieNode.children[ch]) {
          trieNode.children[ch] = new TrieNode(trieNode.prefix + ch, []);
        }
        trieNode.children[ch].value.push(word);
        trieNode = trieNode.children[ch];
      }
    };
    WordTabCompleter.prototype.addAll = function(words) {
      util.array.each(words, this.add.bind(this));
    };
    var PathTabCompleter = function(paths) {
      goog.base(this, paths);
    };
    goog.inherits(PathTabCompleter, WordTabCompleter);
    PathTabCompleter.prototype.list = function(prefix) {
      var pathList = goog.base(this, 'list', prefix);
      var nFullFolders = prefix.split('/').length - 1;
      var values = util.array.map(pathList, function(path) {
        var splitPath = path.split('/');
        return splitPath.length > nFullFolders ? splitPath[nFullFolders] : null;
      }, true /* noNulls */);
      return util.array.noDups(values);
    };
    var Tokenizer = function() {
      this.tokenizedStr_ = '';
      this.originalTokens_ = [];
    };
    Tokenizer.prototype.replace = function(tokenIndex, value) {
      this.originalTokens_[tokenIndex] = value;
      return this.rebuild();
    };
    Tokenizer.prototype.tokenTo = 
        function(str, index, stopChars, not, opt_escape) {
      var start = index;
      var stopCharsArr = stopChars.split('');
      var token = '';
      for  (; index < str.length; index++) {
        if (opt_escape && str[index] == opt_escape) {
          index += 1; // Skip the next char
        } else if (
            (not && $.inArray(str[index], stopCharsArr) < 0) ||
            (!not && $.inArray(str[index], stopCharsArr) >=0)) {
          break;
        }
        if (index < str.length) {
          token += str[index];
        }
      }
      return {index: index, token: token, original: str.slice(start, index)};
    };
    Tokenizer.prototype.nextToken = function(str, index) {
      var delimiterResult = this.tokenTo(str, index, ' =', true /* not */);
      this.tokenizedStr_ += delimiterResult.original;
      var start = delimiterResult.index;
      if (start >= str.length) {
        return null;
      }
      var stopAt = ' =';
      if (str[start] == '"') {
        stopAt = '"';
        start++;
      }
      var result = this.tokenTo(str, start, stopAt, false /* not */, '\\');
      this.tokenizedStr_ += '$' + this.originalTokens_.length + '$';
      if (stopAt == '"') {
        result.index ++; // Skip the quote in the next iteration.
        result.original = '"' + result.original + '"';
      }
      return result;
    };
    Tokenizer.prototype.tokenize = function(str) {
      var tokens = [];
      this.originalTokens_ = [];
      var index = 0;
      var result;
      while (index < str.length && (result = this.nextToken(str, index))) {
        index = result.index;
        tokens.push(result.token);
        this.originalTokens_.push(result.original);
      }
      return tokens;
    };
    Tokenizer.prototype.endsInDelimiter = function() {
      return this.tokenizedStr_.length > 0 && !this.tokenizedStr_.endsWith('$');
    };
    Tokenizer.prototype.rebuild = function() {
      var str = this.tokenizedStr_;
      for (var i = 0; i < this.originalTokens_.length; i++) {
        str = str.replace('$' + i + '$', this.originalTokens_[i]);
      }
      return str;
    };
    Tokenizer.tokenize = function(str) {
      return new Tokenizer().tokenize(str);
    };
    
    // Events
    var EventBus = function() {
      this.listeners_ = {};
    };
    EventBus.prototype.getListeners_ = function(type) {
      return this.listeners_[type] || [];
    };
    EventBus.prototype.subscribe = function(type, fn) {
      this.listeners_[type] = this.getListeners_(type);
      this.listeners_[type].push(fn);
    };
    EventBus.prototype.publish = function(type, opt_data, opt_scope) {
      util.array.each(this.getListeners_(type), function(listener) {
        listener(opt_data);
      });
    };
    var eBus = new EventBus();


    // Console and FileSystem
    var cons = {};
    cons.FileSystem = function() {
      this.path_ = [];
      this.files_ = {};
      this.filesByParent_ = {};
      this.folderPathTabCompleter = new PathTabCompleter();
      this.pathTabCompleter = new PathTabCompleter();
    };
    cons.FileSystem.prototype.init = function(startFolderId) {
      this.path_ = [];
      this.files_ = {};
      this.filesByParent_ = {};
      this.folderPathTabCompleter = new PathTabCompleter();
      this.pathTabCompleter = new PathTabCompleter();
      this.fetchFolders_();
      return this.cdById(startFolderId);
    };
    cons.FileSystem.prototype.fetchFolders_ = function(opt_nLoaded, opt_pageToken) {
      var nLoaded = opt_nLoaded || 0;
      var params = {
        'q': 'trashed=false and mimeType="' + FOLDER_MIMETYPE + '"',
        'maxResults': 500, 
        'pageToken': opt_pageToken,
        'fields': 'items(' + FIELDS +'),nextPageToken'
      };
      Api.exec('GET', 'drive', 'v2', 'files', params).addCallback(
          function(result) {
            this.addFiles_(result.items);
            nLoaded += result.items.length;      
            eBus.publish('fs-folders-loaded', {
              num: nLoaded,
              complete: !result.nextPageToken
            });
            if (result.nextPageToken) {
              this.fetchFolders_(nLoaded, result.nextPageToken);
            }
          }.bind(this), function(error) {
            eBus.publish('fs-folders-load-fail', error);
          }.bind(this));
      // TODO(eschoeffler): Do something on error?
    };
    cons.FileSystem.prototype.addToPath_ = function(folder) {
      this.path_.push(folder);
      this.setPath_(this.path_);
    };
    cons.FileSystem.prototype.setPath_ = function(path) {
      this.path_ = path;
      // Populate the cache.
      this.ls({force: true});
      eBus.publish('fs-cd', this.path_);
    };
    cons.FileSystem.prototype.getHereId = function() {
      return this.path_.length > 0 ? this.path_[this.path_.length - 1].id : null;
    };
    cons.FileSystem.prototype.addFiles_ = function(file) {
      util.array.each(file, function(file) {
        this.addFile_(file, true);
      }.bind(this));
      this.updateTabCompleters_();
    };
    cons.FileSystem.prototype.addFile_ = function(file, opt_dontUpdateTabCompleters) {
      this.removeFile_(file.id);
      this.files_[file.id] = file;
      if (file.parents.length == 0) {
        var children = this.filesByParent_['NOPARENT'] = this.filesByParent_['NOPARENT'] || {};
        children[file.id] = file;
      } else {
        util.array.each(file.parents, function(parent) {
          var children = this.filesByParent_[parent.id] = this.filesByParent_[parent.id] || {};
          children[file.id] = file;
        }.bind(this));
      }
      if (!opt_dontUpdateTabCompleters) {
        this.updateTabCompleters_();
      }
    };
    cons.FileSystem.prototype.removeFile_ = function(id) {
      var file = this.files_[id];
      if (file) {
        delete this.files_[id];
        if (file.parents.length == 0) {
          delete this.filesByParent_['NOPARENT'][id];
        } else {
          util.array.each(file.parents, function(parent) {            
            delete this.filesByParent_[parent.id][id];
          }.bind(this));
        }
      }
    };
    cons.FileSystem.prototype.resolve = function(path, opt_predicate) {
      var predicate = opt_predicate || Predicates.ALL;
      var isAbsolute = path.startsWith('/');
      path = path.replace(/\/$|^\//g, ''); // Remove end slashes.
      var folderNames = path.split('/');
      var resolvedPathNames = [];
      var resolvedPath = isAbsolute ? [] : $.merge([], this.path_);
      for (var i = 0; i < folderNames.length; i++) {
        var folderName = folderNames[i];
        resolvedPathNames.push(folderName);
        if (folderName == '..') {
          if (resolvedPath.length > 0) {
            resolvedPath = resolvedPath.slice(0, resolvedPath.length - 1);
          } else {
            return Deferred.fail(resolvedPathNames.join('/') + ' does not exist');
          }
        } else {
          var currParent = resolvedPath.length > 0 ?
              resolvedPath[resolvedPath.length - 1].id : null;
          var matching = this.query().name(folderName).in(currParent).go();
          if (matching.length == 0) {
            return Deferred.fail(resolvedPathNames.join('/') + ' does not exist');
          } else if (i == folderNames.length - 1) {
            var resolvedPaths = [];
            util.array.each(matching, function(file) {
              var resolvedPathCopy = $.merge([], resolvedPath);
              resolvedPathCopy.push(file);
              resolvedPaths.push(resolvedPathCopy);
            });
            return Deferred.succeed(resolvedPaths);
          } else {
            var currentItem = util.array.first(matching, function(file) {
              return file.mimeType == FOLDER_MIMETYPE;
            });
            if (!currentItem) {
              return Deferred.fail(resolvedPathNames.join('/') + ' is not a folder');
            } else {
              resolvedPath.push(currentItem);
            }
          }
        }
      }
      return Deferred.succeed([resolvedPath]);
    };
    cons.FileSystem.prototype.cd = function(path) {
      var resolvedPaths = this.resolve(path);
      var deferred = new Deferred();
      resolvedPaths.addCallbacks(function(paths) {
        this.setPath_(paths[0]);
        deferred.callback();
      }.bind(this), function(error) {
        if (path.split('/').length == 1) {
          deferred.follow(this.cdById(path));
        } else {
          deferred.errback(error);
        }
      }.bind(this));
      return deferred;
    };
    cons.FileSystem.prototype.cdById = function(id) {
      var matchingDirs = this.query().anywhere().id(id).is(FOLDER_MIMETYPE).go();
      if (matchingDirs.length > 0) {
        this.setPath_([matchingDirs[0]]);
        return Deferred.succeed();
      } else {
        var params = {
          'fields': FIELDS,
          'q': 'trashed = false'
        };
        var deferred = new Deferred();
        Api.exec('GET', 'drive', 'v2', 'files/' + id, params).addCallbacks(
            function(result) {
              this.addFile_(result);
              this.setPath_([result]);
              deferred.callback();
            }.bind(this),
            function(result) {
              deferred.errback('Unknown folder ' + id);
            });
        return deferred;
      }
    };
    cons.FileSystem.prototype.ls = function(opt_options, opt_path) {
      var deferred = new Deferred();
      var resolvedPaths = opt_path ? this.resolve(opt_path) : Deferred.succeed([]);
      resolvedPaths.addCallbacks(function(paths) {
        var parentId = this.getHereId();
        if (paths.length > 0) {
          var path = paths[0];
          if (path.length > 0) {
            var parent = path[path.length - 1];
            if (parent.mimeType != FOLDER_MIMETYPE) {
              deferred.errback(opt_path + ' is not a folder');
              return;
            }
            parentId = parent.id;
          } else {
            parentId = null;
          }
        }
        var options = opt_options || {};
        if (options.force) {
          var params = {
            'fields': 'items(' + FIELDS + ')',
            'maxResults': 100,
            'q': 'trashed=false'
          };
          if (parentId) {
            params['q'] += ' and "' + parentId + '" in parents';
          }
          if (options.isFolder) {
            params['q'] += ' and mimeType="' + FOLDER_MIMETYPE + '"';
          }
          // Implement paging
          Api.exec('GET', 'drive', 'v2', 'files', params).addCallbacks(
              function(result) {
                if (result.items) {
                  this.addFiles_(result.items);
                }
                deferred.callback(result.items);
              }.bind(this),
              deferred.errback.bind(deferred));
          return deferred;
        } else {
          var options = opt_options || {};
          var query = this.query().in(parentId);
          if (options.isFolder) {
            query.is(FOLDER_MIMETYPE);
          }
          deferred.callback(query.go());
        }
      }.bind(this), deferred.errback.bind(deferred));
      return deferred;
    };
    cons.FileSystem.prototype.updateTabCompleters_ = function() {
      this.folderPathTabCompleter.clear();
      this.folderPathTabCompleter.addAll(this.getPaths(this.getHereId(), true /* foldersOnly */));
      this.pathTabCompleter.clear();
      this.pathTabCompleter.addAll(this.getPaths(this.getHereId()));
    };
    cons.FileSystem.prototype.getPaths = function(opt_from, opt_foldersOnly) {
      var children = this.query().in(opt_from || null).go();
      if (children.length == 0) {
        return [];
      } else {
        var paths = [];
        util.array.each(children, function(child) {
          if (!opt_foldersOnly || child.mimeType == FOLDER_MIMETYPE) {
            var pathsFromChild = this.getPaths(child.id, opt_foldersOnly);
            var pathToChild = (!!opt_from ? '' : '/') + child.title;
            paths.push(pathToChild);
            util.array.each(pathsFromChild, function(pathFromChild) {
              paths.push(pathToChild + '/' + pathFromChild);
            });
          }
        }.bind(this));
        return paths;
      }
    };
    cons.FileSystem.prototype.mkfile = function(path, mimeType) {
      var lastSlash = path.lastIndexOf('/');
      var folderPath = path.slice(0, lastSlash + 1);
      var filename = path.slice(lastSlash + 1);
      var deferred = new Deferred();
      var resolvedPaths = folderPath.length > 0 ? this.resolve(folderPath) : Deferred.succeed([]);
      resolvedPaths.addCallbacks(function(paths) {
        var path = paths[0] ? paths[0] : '';
        var parent = path.length > 0  ? path[path.length - 1] : null;
        if (!!parent && parent.mimeType != FOLDER_MIMETYPE) {
          deferred.errback(folderPath + ' is not a folder');
          return;
        } 
        var body = {
          title: filename,
          mimeType: mimeType,
          parents: [{
            id: !!parent ? parent.id : this.getHereId()
          }],
          fields: FIELDS
        };
        var createFile =
            Api.exec('POST', 'drive', 'v2', 'files', {}, JSON.stringify(body));
        createFile.addCallbacks(function(addedFile) {
          this.addFile_(addedFile);
          this.updateTabCompleters_();
        }.bind(this), null);
        deferred.follow(createFile);
      }.bind(this), deferred.errback.bind(deferred));
      return deferred;   
    };
    cons.FileSystem.prototype.rm = function(path) {
      var deferred = new Deferred();
      var resolvedPaths = this.resolve(path);
      resolvedPaths.addCallbacks(function(paths) {
        var path = paths[0]
        var file = path[path.length - 1];
        var deleteDeferred = Api.exec('DELETE', 'drive', 'v2', 'files/' + file.id, {});
        deleteDeferred.addCallbacks(function() {
          this.removeFile_(file.id);
          this.updateTabCompleters_();
        }.bind(this), null);
        deferred.follow(deleteDeferred)
      }.bind(this), deferred.errback.bind(deferred));
      return deferred;
    };
    cons.FileSystem.prototype.getPath = function(dir) {
      return this.path_;
    };
    cons.FileSystem.prototype.query = function() {
      return new cons.FileSystem.Query(this)
    };
    
    
    cons.FileSystem.Query = function(fs) {
      this.fs_ = fs;
      this.files_ = {};
      this.predicates_ = [];
      this.here();
    };
    cons.FileSystem.Query.prototype.id = function(id) {
      this.predicates_.push(function(file) {
        return file.id == id;
      });
      return this;
    };
    cons.FileSystem.Query.prototype.anywhere = function() {
      this.files_ = this.fs_.files_;
      return this;
    };
    cons.FileSystem.Query.prototype.in = function(folderId) {
      if (!folderId) {
        this.files_ = this.fs_.filesByParent_['NOPARENT'] || {};
      } else {
        this.files_ = this.fs_.filesByParent_[folderId] || {};
      }
      return this;
    };
    cons.FileSystem.Query.prototype.here = function() {
      return this.in(this.fs_.getHereId());
    };
    cons.FileSystem.Query.prototype.is = function(mimeType) {
      this.predicates_.push(function(file) {
        return file.mimeType == mimeType;
      });
      return this;
    };
    cons.FileSystem.Query.prototype.name = function(title) {
      this.predicates_.push(function(file) {
        return file.title == title;
      });
      return this;
    };
    cons.FileSystem.Query.prototype.matches = function(predicate) {
      this.predicates_.push(predicate);
      return this;
    };
    cons.FileSystem.Query.prototype.go = function() {
      var matching = [];
      for (var fileId in this.files_) {
        var matches = util.array.all(this.predicates_, function(predicate) {
          return predicate(this.files_[fileId]);
        }.bind(this));
        if (matches) {
          matching.push(this.files_[fileId]);
        }
      }
      matching.sort(function(a, b) {
        if (a.title < b.title) return -1;
        if (a.title > b.title) return 1;
        return 0;
      });
      return matching;
    };

    
    cons.Apps = function() {
      this.apps_ = {};
    };
    cons.Apps.prototype.init = function() {
      // Populate the cache.
      this.ls({force: true});
    };
    cons.Apps.prototype.setApps = function(apps) {
      this.apps_ = [];
      util.array.each(apps, function(app) {
        this.apps_[app.id] = app;
      }.bind(this));
    };
    cons.Apps.prototype.ls = function(opt_options) {
      var options = opt_options || {};
      if (options.force) {
        var deferred = new Deferred();
        // Implement paging
        var params = {'fields': 'items(' + APP_FIELDS + ')'};
        Api.exec('GET', 'drive', 'v2', 'apps', params).addCallbacks(
            function(result) {
              if (result.items) {
                this.setApps(result.items);
              }
              deferred.callback(result.items);
            }.bind(this),
            deferred.errback.bind(this));
        return deferred;
      } else {
        return Deferred.succeed(this.find(Predicates.ALL));
      }
    };
    cons.Apps.prototype.open = function(file) {
      var apps = this.find(function(app) {
        return ($.inArray(file.mimeType, app.primaryMimeTypes) >= 0 ||
            $.inArray(file.mimeType, app.secondaryMimeTypes) >= 0 ||
            $.inArray(file.fileExtension, app.primaryFileExtensions) >=0 ||
            $.inArray(file.fileExtension, app.secondaryFileExtensions) >=0) &&
            !!app.openUrlTemplate;
      });
      if (apps.length == 0) {
        return Deferred.fail('No apps can open ' + filename);
      } else {
        var openUrl = apps[0].openUrlTemplate.replace('{ids}', file.id).replace('{exportIds}', '');
        window.open(openUrl, '_blank');
        return Deferred.succeed();
      }
    };
    cons.Apps.prototype.find = function(predicate) {
      var matching = [];
      for (var appId in this.apps_) {
        if (predicate(this.apps_[appId])) {
          matching.push(this.apps_[appId]);
        }
      }
      return matching;
    };
    
    
    cons.Console = function(fileSystem) {
      this.cursor_ = $('#input-cursor');
      this.consEl_ = $('#cons');
      this.consEl_.on('mouseup', this.onMouseUp_.bind(this));
      this.outputEl_ = $('#output');
      this.inputContainerEl_ = $('#input-container');
      this.inputEl_ = $('#input');
      this.inputEl_.on('keydown', this.onKeyDown_.bind(this));
      this.inputEl_.on('input', this.onInput_.bind(this));
      this.inputEl_.val(this.prompt_);
      this.history_ = [];
      this.historyCursor_ = 0;
      this.commands_ = {};
      this.setLocation_(fileSystem.getPath());
      this.cmdTabCompleter_ = new WordTabCompleter();
      eBus.subscribe('fs-cd', this.setLocation_.bind(this));
      eBus.subscribe('fs-folders-loaded', function(e) {
        if (e.complete) {  
          this.write('All folders (' + e.num + ') loaded into cache');
        } else {
          this.write(e.num + ' folders loaded into cache');
        }
      }.bind(this));
      eBus.subscribe('fs-folders-load-fail', function(error) {
        if (e.complete) {  
          this.write('Failed to load all folders into cache: ' + error);
        }
      }.bind(this));
    };
    cons.Console.prototype.focus = function() {
      this.inputEl_.focus();
      this.scrollToBottom();
    };
    cons.Console.prototype.setLocation_ = function(path) {
      var folderNames = [];
      util.array.each(path, function(folder) {
        folderNames.push(folder.title);
      });
      var pathStr = folderNames.length > 0 ? folderNames.join('/') : 'The ether';
      this.cursor_.text(pathStr + ' > ');
    };
    cons.Console.prototype.installCommand = function(cmdName, cmd) {
      if (!(cmd instanceof commands.Command)) {
        cmd = new commands.Fn(this, cmd);
      }
      this.commands_[cmdName] = cmd;
      this.cmdTabCompleter_.add(cmdName);
    };
    cons.Console.prototype.onMouseUp_ = function(e) {
      var selection = window.getSelection().toString();
      if (selection.length == 0) {
        util.doLater(this.focus.bind(this));
      }
    };
    cons.Console.prototype.onInput_ = function() {
      this.inputEl_.height(1);
      this.inputEl_.height(this.inputEl_[0].scrollHeight);
    };
    cons.Console.prototype.onKeyDown_ = function(e) {
      var handled = false;
      if (e.shiftKey || e.ctrlKey || e.metaKey || e.altKey) {
        return;
      }
      if (e.which == 13) { // Enter is pressed
        this.submit_();
        handled = true;
      } else if (e.which == 38) { // Up arrow
        this.historyCursor_ = Math.max(this.historyCursor_ - 1, 0);
        var val = this.history_[this.historyCursor_];
        this.inputEl_.val(val);
        handled = true;
      } else if (e.which == 40) { // Down arrow
        this.historyCursor_ = Math.min(this.historyCursor_ + 1, this.history_.length);
        var val = this.historyCursor_ < this.history_.length ?
            this.history_[this.historyCursor_] : '';
        this.inputEl_.val(val);
        handled = true;
      } else if (e.which == 9) { // Tab
        this.tabComplete_();
        handled = true;
      }
      if (handled) {
        e.preventDefault();
        return false;
      }
    };
    cons.Console.prototype.tabComplete_ = function() {
      var tokenizer = new Tokenizer();
      var currentVal = this.inputEl_.val();
      var args = tokenizer.tokenize(currentVal);
      var lastArg = tokenizer.endsInDelimiter() ?
          '' : args[args.length - 1] || '';
      var tabCompleter = new WordTabCompleter();
      if (args.length <= 1 && !tokenizer.endsInDelimiter()) {
        tabCompleter = this.cmdTabCompleter_;
      } else {
        var cmd = this.getCmd(args[0]);
        tabCompleter = cmd ? cmd.getTabCompleter() : new WordTabCompleter();
      }
      // Add other tab completers;
      var completion = tabCompleter.complete(lastArg);
      if (completion && completion != lastArg) {
        // Figure out how to replace in the middle of the string.
        completion = completion.replace(/ /g, '\\ ');
        this.inputEl_.val(tokenizer.replace(args.length - 1, completion));
        this.focus();
      } else {
        var words = tabCompleter.list(lastArg);
        if (words.length > 1) {
          this.writeInput_();
          this.writeList(words, function(word) { return word; });
        } else if (words.length == 1) {
          this.inputEl_.val(currentVal + ' ');
          this.focus();
        } else {
          this.writeInput_();
          this.write('No known tab completions');
        }
      }
    };
    cons.Console.prototype.write = function(text) {
      if (text && text.length > 0) {
        this.writeHTML(
             $('<div/>', {class: "output-block output-block-text", text: text}));
      }
    };
    cons.Console.prototype.writeImg = function(url) {
      if (url && url.length > 0) {
        this.writeHTML($('<img/>', {class: "output-block output-block-img", src: url}));
      }
    };
    cons.Console.prototype.writeHTML = function(el) {
      el.appendTo(this.outputEl_);
      util.doLater(this.scrollToBottom.bind(this));
    };
    cons.Console.prototype.writeList = function(list, nameFn, opt_classFn) {
      if (list.length <= 0) { return; }
      var output =  $('<div/>', {class: "output-block"});
      var maxLength = 0;
      util.array.each(list, function(item) {
        maxLength = Math.max(nameFn(item).length, maxLength);
      });
      util.array.each(list, function(item) {
        var className = 'ls-item';
        if (opt_classFn && opt_classFn(item)) {
          className += ' ' + opt_classFn(item);
        }
        output.append($('<div/>', {
            class: className,
            text: nameFn(item),
            width: maxLength + 'em'}));
      });
      c.writeHTML(output);
    };
    cons.Console.prototype.writeInput_ = function() {
      var val = this.inputEl_.val();
      var inputClone = this.inputContainerEl_.clone();
      var input = inputClone.children('#input');
      var disabledInput = $('<div/>', {class: 'input', text: val});
      input.before(disabledInput);
      input.remove();
      this.writeHTML(inputClone);
    };
    cons.Console.prototype.scrollToBottom = function() {
      this.consEl_.animate({scrollTop: this.consEl_[0].scrollHeight});
    };
    cons.Console.prototype.enableInput = function(enable) {
      if (enable) {
        this.inputContainerEl_.show();
        this.focus();
      } else {
        this.inputContainerEl_.hide();
      }
    };
    cons.Console.prototype.getCmd = function(cmdName) {
      return this.commands_[cmdName];
    };
    cons.Console.prototype.submit_ = function() {
      var argStr = this.inputEl_.val();
      this.writeInput_();
      this.inputEl_.val('');
      this.history_.push(argStr);
      this.historyCursor_ = this.history_.length;
      this.enableInput(false);
      try {
        var result = this.execStr(argStr);
      } catch (e) {
        this.write(e.toString());
        this.enableInput(true);
        return;
      }
      result.addErrback(function(errMsg) {
        if (errMsg) {
          this.write(errMsg);
        }
      }.bind(this));
      result.addBoth(function(val) {
        this.enableInput(true);
        this.focus();
      }.bind(this));
    };
    cons.Console.prototype.execStr = function(command) {
      return this.exec(Tokenizer.tokenize(command), command);
    };
    cons.Console.prototype.exec = function(args, command) {
      if (this.commands_[args[0]]) {
        return this.commands_[args[0]].exec(args, command);
      } else {
        return Deferred.fail('Sorry I don\'t know of the command ' + args[0]);
      }
    };
    cons.Console.prototype.getCommandTabCompleter = function() {
      return this.cmdTabCompleter_;
    };
    var fs = new cons.FileSystem();
    var a = new cons.Apps();
    var c = new cons.Console(fs);
    c.enableInput(false);
    c.write('Welcome to the Google Drive console. Connecting to Drive...');

    Api = {};
    Api.root = undefined;
    Api.exec = function(method, collection, version, path, opt_params, opt_body, opt_isUpload) {
      var req = gapi.client.request({
        path: (opt_isUpload ? 'upload/' : '') + collection + '/' + version + '/' + path,
        method: method,
        params: opt_params,
        body: opt_body,
        root: Api.root
      });
      return Api.executeReq_(req);
    };
    Api.get = function(url, isBlob) {
      var deferred = new Deferred();
      var accessToken = gapi.auth.getToken().access_token;
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url);
      xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
      xhr.onload = function() {
        deferred.callback(isBlob ? xhr.response : xhr.responseText);
      };
      xhr.onerror = function() {
        deferred.errback(xhr.responseCode + ': ' + xhr.statusText);
      };
      if (isBlob) {
        xhr.responseType = 'blob';
      }
      xhr.send();
      return deferred;
    };
    Api.executeReq_ = function(req) {
      var deferred = new Deferred();
      req.execute(function(resp, rawResponse) {
        if (typeof resp === 'undefined') {
          deferred.callback();
        } else if (!resp) {
          deferred.errback(rawResponse);
        } else if (resp.error) {
          deferred.errback(JSON.stringify(resp, null, '  '));
        } else if (resp.result) {
          deferred.callback(resp.result);
        } else {
          deferred.callback(resp);
        }
      });
      return deferred;
    };
    
    /** Commands */
    commands = {};
    commands.getParams = function(args) {
      var params = {};
      for (var index = 0; index < args.length; index++) {
        if (args[index].startsWith('-')) {
          var start = args[index].startsWith('--') ? 2 : 1;
          var key = args[index].slice(start);
          if (index + 1 < args.length && !args[index + 1].startsWith('-')) {
            index++;
            params[key] = args[index];
          } else {
            params[key] = true;
          }
        }
      }
      return params;
    };
    
    
    commands.Flag = function(name, defaultVal, desc) {
      this.name_ = name;
      this.desc_ = desc;
      this.defaultVal_ = defaultVal;
      this.value = defaultVal;
    };
    commands.Flag.prototype.helpText = function() {
      var str = '--' + this.name_ + ' ' + this.desc_;
      if (this.defaultVal_) {
        str += ' (Default is ' + this.defaultVal_ + ')';
      }
      return str;
    };
    commands.Flag.prototype.reset = function() {
      this.value = this.defaultVal_;
    };
    commands.Flag.prototype.get = function() {
      return this.value;
    };
    
    
    commands.Command = function(out, desc) {
      this.out = out;
      this.desc_ = desc;
      this.registeredFlags_ = {};
      this.otherFlags_ = {};
      this.params_ = [];
    };
    commands.Command.prototype.exec = function(args, command) {
      util.object.each(this.registeredFlags_, function(flag) {
        flag.reset();
      });
      this.otherFlags_ = {};
      this.params_ = [];
      this.parseParams(args);
      return this.execInternal(this.params_, this.otherFlags_, args, command);
    };
    commands.Command.prototype.execInternal = function(params, otherFlags, args, command) {
      return Deferred.succeed();
    };
    commands.Command.prototype.registerFlag = function(name, defaultVal, desc) {
      var flag = new commands.Flag(name, defaultVal, desc);
      if (this.registeredFlags_[name]) { 
        throw new Error('Two flags registered with the same name ' + name);
      }
      this.registeredFlags_[name] = flag;
      return flag;
    };
    commands.Command.prototype.parseParams = function(args) {
      for (var index = 1; index < args.length; index++) {
        if (args[index].startsWith('-')) {
          var start = args[index].startsWith('--') ? 2 : 1;
          var name = args[index].slice(start);
          var value;
          if (index + 1 < args.length && !args[index + 1].startsWith('-')) {
            index++;
            value = args[index];
          } else {
            value = true;
          }
          if (this.registeredFlags_[name]) {
            this.registeredFlags_[name].value = value;
          } else {
            this.otherFlags_[name] = value;
          }
        } else {
          this.params_.push(args[index]);
        }
      }
    };
    commands.Command.prototype.help = function() {
      this.out.write(this.desc_);
      if (Object.keys(this.registeredFlags_).length > 0) {
        this.out.write('Available flags: ');
        util.object.each(this.registeredFlags_, function(flag) {
          this.out.write(flag.helpText());
        }.bind(this));
      }
    };
    commands.Command.prototype.getTabCompleter = function(args) {
      return new WordTabCompleter();
    };
    
    commands.Fn = function(out, fn) {
      goog.base(this, out, 'No help description for this command.');
      this.fn_ = fn;
    };
    goog.inherits(commands.Fn, commands.Command);
    commands.Fn.prototype.execInternal = function(params, otherFlags, args, command) {
      return this.fn_(args);
    };
    
    commands.Auth = function(cons) {
      goog.base(this, cons, 'Authorizes the Google API for a user.');
      this.user_ = this.registerFlag('u', undefined, 'The auth user index for which to authorize.');
      this.scopeStr_ = this.registerFlag('scopes',
          'drive drive.apps.readonly drive.appdata userinfo.email',
          'A space or comma separated list of scopes for which the user will be authorized. ' +
          'These can either be full scopes, or just the portion after ' +
          'https://www.googleapis.com/auth/.');
      this.clientId_ = this.registerFlag('clientId',
          '224902143792-29hn7nslf4h6bed6ridpqeivklevkek0.apps.googleusercontent.com',
          'The client ID of the app to authorize.');
      this.immediate_ = this.registerFlag('i', false,
          'Whether to attempt to authorize immediately without bringing up a dialog.');
      this.cons_ = cons;
    };
    goog.inherits(commands.Auth, commands.Command);
    commands.Auth.prototype.execInternal = function(params, otherFlags, args, command) {
      var scopes = this.scopeStr_.get().split(/[,\s]+/);
      for (var i = 0; i < scopes.length; i++) {
        if (!scopes[i].startsWith('https')) {
          scopes[i] = 'https://www.googleapis.com/auth/' + scopes[i];
        }
      }
      var config = {
        'client_id': this.clientId_.get(),
        'scope': scopes.join(' '),
        'authuser': this.user_.get(),
        'immediate': this.immediate_.get()
      };
      var deferred = new Deferred();
      gapi.auth.authorize(config, function(result) {
        if (result && !result.error) {
          Api.exec('GET', 'oauth2', 'v1', 'userinfo', {alt: 'json'}).addCallbacks(
              function(result) {
                this.cons_.write(
                    'Authorized as ' + result.email + '. Type token to get token info.');
                deferred.callback();
              }.bind(this), function(result) {
                deferred.errback('Failed to authorize ' + result);
              });
        } else {
          deferred.errback(result);
        }
      }.bind(this));
      return deferred;
    };

    commands.Call = function(out, fs) {
      goog.base(this, out, 'Makes an API call. ' +
          'Usage: call [method] [collection/version/path]. ' +
          'Any flags not listed below are passed directly as parameters ' +
          'to the API call.\n\n' +
          'Example: call GET drive/v2/files');
      this.body_ = this.registerFlag('body', '',
          'A JSON representation of the body of the request.');
      this.fs_ = fs;
    };
    goog.inherits(commands.Call, commands.Command);
    commands.Call.prototype.execInternal = function(params, otherFlags, args, command) {
      if (params.length < 2) {
        return Deferred.fail('Usage: call [method] [collection/version/path]');
      }
      var method = params[0];
      var path = params[1].split('/');
      if (path.length < 3) {
        return Deferred.fail('Usage: call [method] [collection/version/path]');
      }
      var collection = path[0];
      var version = path[1];
      var remainingPath = path.slice(2).join('/');
      var deferred = new Deferred();
      Api.exec(method, collection, version, remainingPath, otherFlags, this.body_.get()).
          addCallbacks(
              function(resp) {
                $1 = resp;
                this.out.write(JSON.stringify(resp, null, '  '));
                deferred.callback();
              }.bind(this),
              deferred.errback.bind(deferred));
      return deferred;
    };

    commands.Cat = function(out, fs) {
      goog.base(this, out, 'Displays the contents of a file.');
      this.fs_ = fs;
    };
    goog.inherits(commands.Cat, commands.Command);
    commands.Cat.prototype.execInternal = function(params, otherFlags, args, command) {
      if (params.length < 1) { return Deferred.fail('Usage: cat [filename]'); }
      var deferred = new Deferred();
      var resolvedPaths = this.fs_.resolve(params[0]);
      resolvedPaths.addCallbacks(function(paths) {
        var files = util.array.map(paths, function(path) { return path[path.length - 1]; });
        var downloadableFile = util.array.first(files, function(file) {
          return !!file.downloadUrl;
        });
        if (!downloadableFile) {
          return Deferred.fail(params[0] + ' cannot be displayed');
        }
        var isImage = downloadableFile.mimeType.startsWith('image');
        var getContent = Api.get(downloadableFile.downloadUrl, isImage);
        getContent.addCallbacks(function(response) {
          if (isImage) {
            this.out.writeImg((window.URL || window.webkitURL).
                createObjectURL(response));
          } else {
            this.out.write(response);
          }
        }.bind(this), null);
        deferred.follow(getContent);
      }.bind(this), deferred.errback.bind(deferred));
      return deferred;
    };
    commands.Cat.prototype.getTabCompleter = function() {
      return this.fs_.pathTabCompleter;
    };

    commands.Cd = function(out, fs) {
      goog.base(this, out, 'Change the current working directory. Usage cd [path].');
      this.fs_ = fs;
    };
    goog.inherits(commands.Cd, commands.Command);
    commands.Cd.prototype.execInternal = function(params, otherFlags, args, command) {
      if (params.length < 1) { return Deferred.fail('Usage: cd [path]'); }
      return this.fs_.cd(params[0]);
    };
    commands.Cd.prototype.getTabCompleter = function() {
      return this.fs_.folderPathTabCompleter;
    };

    commands.Connect = function(cons, fs, apps) {
      goog.base(this, cons, 'Connects this cons to a drive instance.');
      this.qual_ = this.registerFlag('q', false, 'Whether to use the qual root. ' +
          'If provided, this will override the --root flag.');
      this.root_ = this.registerFlag('root', 'prod', 'The API root to connect to. ' +
          'This should be of the form "https://content-googleapis-test.sandbox.google.com". ' +
          'But you can also provide qual or prod as aliases for the TEST and PROD roots.');
      this.fs_ = fs;
      this.apps_ = apps;
    };
    goog.inherits(commands.Connect, commands.Command);
    commands.Connect.prototype.execInternal = function(params, otherFlags, args, command) {
      var deferred = new Deferred();
      var root = this.qual_.get() ? 'qual' : this.root_.get();
      switch (root) {
        case 'qual': Api.root = QUAL_URL; break;
        case 'prod': Api.root = undefined; break;
        default: Api.root = root; break;
      }
      var getAbout = Api.exec('GET', 'drive', 'v2', 'about', {});
      c.write('Connecting to Drive...');
      getAbout.addCallbacks(function(resp) {
        this.apps_.init();
        deferred.follow(this.fs_.init(resp.rootFolderId));
      }.bind(this), deferred.errback.bind(deferred));
      return deferred;
    };

    commands.Dcall = function(out, fs) {
      goog.base(this, out, 'Makes a Drive API call. ' +
          'Usage: call [method] [path]. ' +
          'Any flags not listed below are passed directly as parameters ' +
          'to the API call.\n\n' +
          'Example: call GET drive/v2/files');
      this.version_ = this.registerFlag('version', 'v2', 'The version of the Drive API to use.')
      this.fs_ = fs;
    };
    goog.inherits(commands.Dcall, commands.Call);
    commands.Dcall.prototype.execInternal = function(params, otherFlags, args, command) {
      if (params.length < 2) {
        return Deferred.fail('Usage: call [method] [path]');
      }
      params[1] = 'drive/' + this.version_.get() + '/' + params[1];
      return goog.base(this, 'execInternal', params, otherFlags, args, command);
    };

    commands.Edit = function(out, fs) {
      goog.base(this, out, 'Edit a file or create a new one. Usage: edit [filename] [opt_mimetype]');
      this.fs_ = fs;
    };
    goog.inherits(commands.Edit, commands.Command);
    commands.Edit.prototype.execInternal = function(params, otherFlags, args, command) {
      if (params.length < 1) { return Deferred.fail('Usage: edit [filename] [opt_mimetype]'); }
      var deferred = new Deferred();
      var resolvedPaths = this.fs_.resolve(params[0]);
      resolvedPaths.addCallbacks(function(paths) {
        var files = util.array.map(paths, function(path) { return path[path.length - 1]; });
        var downloadableFile = util.array.first(files, function(file) {
          return !!file.downloadUrl;
        });
        if (!downloadableFile) {
          deferred.errback(params[0] + ' cannot be edited inline, try using the open command.');
        } else {
          var editor = new commands.Edit.Editor(downloadableFile);
          deferred.follow(editor.show(true));
        }
      }.bind(this), function() {
        var createFileDeferred = this.fs_.mkfile(params[0], (params[1] || 'text/plain'));
        createFileDeferred.addCallbacks(function(file) {
          var editor = new commands.Edit.Editor(file)
          deferred.follow(editor.show(true));
        }, deferred.errback.bind(deferred));
      }.bind(this));
      return deferred;
    };
    commands.Edit.prototype.getTabCompleter = function() {
      return this.fs_.pathTabCompleter;
    };

    commands.Edit.Editor = function(file) {
      this.file_ = file;
      this.deferred_ = new Deferred();
      this.editControl_ = null;
      this.textArea_ = null;
      this.commandInput_ = null;
      this.createDom_();
    };
    commands.Edit.Editor.DEFAULT_MSG_ = 'Esc enters command mode. '+
        'w saves, q quits, and wq saves and quits.';
    commands.Edit.Editor.prototype.createDom_ = function() {
      this.editControl_ = $('<div/>', {class: 'full-page-control'});
      this.textArea_ = $('<textarea/>', {class: 'editor-text-area'});
      this.commandInput_ = $('<input/>', {class: 'editor-input'});
      this.editControl_.append(this.textArea_);
      this.editControl_.append(this.commandInput_);
      this.textArea_.on('keydown', this.onKeyDown_.bind(this));
      this.commandInput_.on('keydown', this.onCommandKeyDown_.bind(this));
    };
    commands.Edit.Editor.prototype.onKeyDown_ = function(e) {
      if (e.keyCode == 27) { // Esc
        this.commandInput_.val('');
        this.commandInput_.focus();
        e.preventDefault();
        return false;
      }
    };
    commands.Edit.Editor.prototype.onCommandKeyDown_ = function(e) {
      var handled = false;
      if (e.which == 13) { // Enter
        util.doLater(this.submit_.bind(this));
        handled = true;
      } else if (e.keyCode == 27) { // Esc
        this.write_(commands.Edit.Editor.DEFAULT_MSG_);
        this.textArea_.focus();
        handled = true;
      }
      if (handled) {
        e.preventDefault();
        return false;
      }
    };
    commands.Edit.Editor.prototype.submit_ = function() {
      var commands = this.commandInput_.val().split('');
      this.commandInput_.val('');
      this.textArea_.focus();
      var deferred = Deferred.succeed();
      if ($.inArray('w', commands) >=0) {
        deferred = this.save_();
      }
      if ($.inArray('q', commands) >=0) {
        deferred.addCallback(function() {
          this.editControl_.remove();
          this.deferred_.callback();
        }.bind(this));
      }
    };
    commands.Edit.Editor.prototype.write_ = function(text) {
      this.commandInput_.val(text);
    };
    commands.Edit.Editor.prototype.show = function() {
      $('body').append(this.editControl_);
      this.textArea_.focus();
      this.write_('Loading ' + this.file_.title + '...');
      Api.get(this.file_.downloadUrl).addCallbacks(
          this.handleFileLoaded_.bind(this),
          function(errorMsg) {
            this.write_('Error loading ' + this.file_.title + ': ' + errorMsg);
          });
      return this.deferred_;
    };
    commands.Edit.Editor.prototype.handleFileLoaded_ = function(content) {
      this.textArea_.val(content);
      this.textArea_[0].setSelectionRange(0, 0);
      this.write_(commands.Edit.Editor.DEFAULT_MSG_);
    };
    commands.Edit.Editor.prototype.save_ = function() {
      var deferred = Api.exec('PUT', 'drive', 'v2', 'files/' + this.file_.id,
          {}, this.textArea_.val(), true);
      this.write_('Saving ' + this.file_.title + '...');
      deferred.addCallbacks(function() {
        this.write_('Saved');
      }.bind(this), function() {
        this.write_('Error saving ' + this.file_.title);
      }.bind(this));
      return deferred;
    };
    
    commands.Js = function(out) {
      goog.base(this, out, 'Execute arbitrary javascript. Output is the output of the execution.');
    };
    goog.inherits(commands.Js, commands.Command);
    commands.Js.prototype.execInternal = function(params, otherFlags, args, command) {
      this.out.write('' + eval(command.split(' ').slice(1).join(' ')));
      return Deferred.succeed();
    };

    commands.Ls = function(out, fs) {
      goog.base(this, out, 'List files in the current directory');
      this.fs_ = fs;
      this.folderOnly_ = this.registerFlag('d', false, 'Whether to list directories only.');
      this.force_ = this.registerFlag('f', false, 'Whether to requery the API. ' +
          'If not set, this will list files from a cache');
    };
    goog.inherits(commands.Ls, commands.Command);
    commands.Ls.prototype.execInternal = function(params, otherFlags, args, command) {
      var result = this.fs_.ls({
        isFolder: this.folderOnly_.get(),
        force: this.force_.get()
      }, params[0]);
      var deferred = new Deferred();
      result.addCallbacks(
          function(files) {
            this.out.writeList(files,
                function(file) { 
                  return file.title;
                },
                function(file) { 
                  return file.mimeType == FOLDER_MIMETYPE ?
                      'ls-item-folder' : '';
                });
            deferred.callback();
          }.bind(this),
          deferred.errback.bind(deferred));
      return deferred;
    };
    commands.Ls.prototype.getTabCompleter = function() {
      return this.fs_.folderPathTabCompleter;
    };

    commands.La = function(out, apps) {
      goog.base(this, out, 'List currently installed apps');
      this.apps_ = apps;
      this.force_ = this.registerFlag('f', false, 'Whether to requery the API. ' +
          'If not set, this will list apps from a cache');
    };
    goog.inherits(commands.La, commands.Command);
    commands.La.prototype.execInternal = function(params, otherFlags, args, command) {
      var result = this.apps_.ls({
        force: this.force_.get()
      });
      var deferred = new Deferred();
      result.addCallbacks(
          function(apps) {
            c.writeList(apps,
                function(app) { 
                  return app.name;
                });
            deferred.callback();
          }, deferred.errback.bind(deferred));
      return deferred;
    };

    commands.Man = function(cons) {
      goog.base(this, cons, 'Get help for the given command. Usage help [cmd].');
      this.cons_ = cons;
    };
    goog.inherits(commands.Man, commands.Command);
    commands.Man.prototype.execInternal = function(params, otherFlags, args, command) {
      if (params.length < 1) { return Deferred.fail('Usage: man [cmd]'); }
      var cmd = this.cons_.getCmd(params[0]);
      if (cmd) {
        cmd.help(); 
      } else {
        this.out.write('No help for ' + args[0] + '. Command isn\'t installed');
      }
      return Deferred.succeed();
    };
    commands.Man.prototype.getTabCompleter = function() {
      return this.cons_.getCommandTabCompleter();
    };
    
    commands.Mkdir = function(out, fs) {
      goog.base(this, out,
          'Create a directory in the current directory. Usage mkdir [foldername].');
      this.fs_ = fs;
    };
    goog.inherits(commands.Mkdir, commands.Command);
    commands.Mkdir.prototype.execInternal = function(params, otherFlags, args, command) {
      if (params.length < 1) { return Deferred.fail('Usage: mkdir [foldername]'); }
      return this.fs_.mkfile(params[0], FOLDER_MIMETYPE);
    };

    commands.Mkfile = function(out, fs) {
      goog.base(this, out,
          'Create a file in the current directory. Usage mkdir [name] [MIME type].');
      this.fs_ = fs;
    };
    goog.inherits(commands.Mkfile, commands.Command);
    commands.Mkfile.prototype.execInternal = function(params, otherFlags, args, command) {
      if (params.length < 2) { return Deferred.fail('Usage mkdir [name] [MIME type]'); }
      return this.fs_.mkfile(params[0], params[1]);
    };

    commands.Open = function(out, apps, fs) {
      goog.base(this, out,
          'Opens a file with the first found app that can open it. Usage: open [filename].');
      this.fs_ = fs;
      this.apps_ = apps;
    };
    goog.inherits(commands.Open, commands.Command);
    commands.Open.prototype.execInternal = function(params, otherFlags, args, command) {
      if (params.length < 1) { return Deferred.fail('Usage: open [filename]'); }
      var resolvedPaths = this.fs_.resolve(params[0]);
      var deferred = new Deferred();
      resolvedPath.addCallbacks(function(paths) {
        deferred.follow(this.apps_.open(paths[0][path.length - 1]));
      }.bind(this), deferred.errback.bind(deferred));
      return deferred;
    };
    commands.Open.prototype.getTabCompleter = function() {
      return this.fs_.pathTabCompleter;
    };

    commands.Rm = function(out, fs) {
      goog.base(this, out, 'Deletes a file from the given directory. Usage: rm [filename].');
      this.fs_ = fs;
    };
    goog.inherits(commands.Rm, commands.Command);
    commands.Rm.prototype.execInternal = function(params, otherFlags, args, command) {
      if (params.length < 1) { return Deferred.fail('Usage: rm [filename]'); }
      return this.fs_.rm(params[0]);
    };
    commands.Rm.prototype.getTabCompleter = function() {
      return this.fs_.pathTabCompleter;
    };

    commands.SetRoot = function(cons) {
      goog.base(this, cons,
          'Sets the root to use for all API calls. Usage: setRoot [qual|prod|ROOT_URL]');
      this.cons_ = cons;
    };
    goog.inherits(commands.SetRoot, commands.Command);
    commands.SetRoot.prototype.execInternal = function(params, otherFlags, args, command) {
      if (params.length < 1) {
        return Deferred.fail('Usage: setRoot [qual|prod|ROOT_URL]');
      }
      return this.cons_.execStr('connect --root=' + params[0]);
    };

    commands.Start = function(cons) {
      goog.base(this, cons,
          'Authorizes then connects. All flags are passed through to auth and connect. ' +
          'See man connect and man auth for details');
      this.cons_ = cons;
    };
    goog.inherits(commands.Start, commands.Command);
    commands.Start.prototype.execInternal = function(params, otherFlags, args, command) {
      var deferred = new Deferred();
      var authResult = this.cons_.execStr('auth ' + command.split(' ').slice(1).join(' '));
      authResult.addCallbacks(function(val) {
        deferred.follow(this.cons_.execStr('connect ' + command.split(' ').slice(1).join(' ')));
      }.bind(this), deferred.errback.bind(deferred));
      return deferred;
    };
    
    commands.Token = function(out) {
      goog.base(this, out, 'Displays the current auth token. Usage: token');
    };
    goog.inherits(commands.Token, commands.Command);
    commands.Token.prototype.execInternal = function(params, otherFlags, args, command) {
      this.out.write(JSON.stringify(gapi.auth.getToken(), null, '  '));
      return Deferred.succeed();
    };

    $(window).load(function() {
      c.installCommand('auth', new commands.Auth(c));
      c.installCommand('call', new commands.Call(c));
      c.installCommand('cat', new commands.Cat(c, fs));
      c.installCommand('connect', new commands.Connect(c, fs, a));
      c.installCommand('dcall', new commands.Dcall(c));
      c.installCommand('edit', new commands.Edit(c, fs));
      c.installCommand('cd', new commands.Cd(c, fs));
      c.installCommand('js', new commands.Js(c));
      c.installCommand('ls', new commands.Ls(c, fs));
      c.installCommand('la', new commands.La(c, a));
      c.installCommand('man', new commands.Man(c));
      c.installCommand('mkdir', new commands.Mkdir(c, fs));
      c.installCommand('mkfile', new commands.Mkfile(c, fs));
      c.installCommand('open', new commands.Open(c, a, fs));
      c.installCommand('rm', new commands.Rm(c, fs));
      c.installCommand('setRoot', new commands.SetRoot(c));
      c.installCommand('start', new commands.Start(c));
      c.installCommand('token', new commands.Token(c));
  
      var q = queryParam('q');
      var u = queryParam('u');
      var startCommand = 'start --i';
      if (q) {
        startCommand += ' --q';
      }
      if (u) {
        startCommand += ' --u=' + u;
      }
      c.execStr(startCommand).
          addCallbacks(
          function() {
            c.enableInput(true);
          },
          function() {
            c.write('Connection requires popup. Type start to connect.');
            c.enableInput(true);
          });
    });
  </script>
</html>
